USE [GD2C2020]
GO


-- Dropeo de tablas
IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Venta_Auto')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Venta_Auto
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Compra_Auto')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Compra_Auto
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Venta_Autoparte')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Venta_Autoparte
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Compra_Autoparte')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Compra_Autoparte
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Autoparte')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Autoparte
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Modelo')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Modelo
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Sucursal')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Sucursal
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Tipo_Transmision')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Tipo_Transmision
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Tipo_Caja')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Tipo_Caja
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Tipo_Auto')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Tipo_Auto
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Fabricante')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Fabricante
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Potencia_Rango')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Potencia_Rango
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Mes')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Mes
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Cliente')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Cliente
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Cantidad_Rango')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Cantidad_Rango
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Cantidad_Cambios')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Cantidad_Cambios
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Tipo_Motor')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Tipo_Motor
GO

IF (EXISTS (SELECT * FROM sys.objects WHERE name = 'BI_Rubro_Autoparte')) 
	DROP TABLE NAPOLITANA_CON_FRITAS.BI_Rubro_Autoparte
GO

-- Creacion de las tablas de dimensiones
CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Sucursal (
SUCURSAL_ID [decimal](18, 0) PRIMARY KEY,
SUCURSAL_DIRECCION [nvarchar](255) NULL,
SUCURSAL_MAIL [nvarchar](255) NULL,
SUCURSAL_TELEFONO [decimal](18, 0) NULL,
SUCURSAL_CIUDAD [nvarchar](255) NULL
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Tipo_Transmision (
TIPO_TRANSMISION_CODIGO decimal(18,0) PRIMARY KEY,
TIPO_TRANSMISION_DESC nvarchar(255)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Tipo_Caja (
TIPO_CAJA_CODIGO decimal(18,0) PRIMARY KEY,
TIPO_CAJA_DESC nvarchar(255)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Tipo_Auto (
TIPO_AUTO_CODIGO decimal(18,0) PRIMARY KEY,
TIPO_AUTO_DESC nvarchar(255)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Fabricante (
FABRICANTE_ID decimal(18,0) PRIMARY KEY,
FABRICANTE_NOMBRE nvarchar(255) 
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Modelo (
MODELO_CODIGO decimal(18,0) PRIMARY KEY,
MODELO_NOMBRE nvarchar(255),
MODELO_POTENCIA decimal(18,0),
MODELO_FABRICANTE decimal(18,0),
MODELO_TIPO_TRANSMISION decimal(18,0),
MODELO_TIPO_CAJA decimal(18,0),
MODELO_TIPO_MOTOR decimal(18,0),
MODELO_TIPO_AUTO decimal(18,0),
FOREIGN KEY (MODELO_FABRICANTE) REFERENCES NAPOLITANA_CON_FRITAS.BI_Fabricante(FABRICANTE_ID),
FOREIGN KEY (MODELO_TIPO_TRANSMISION) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Transmision(TIPO_TRANSMISION_CODIGO),
FOREIGN KEY (MODELO_TIPO_CAJA) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Caja(TIPO_CAJA_CODIGO),
FOREIGN KEY (MODELO_TIPO_AUTO) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Auto(TIPO_AUTO_CODIGO)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Autoparte (
AUTOPARTE_CODIGO decimal(18,0) PRIMARY KEY,
AUTOPARTE_DESCRIPCION nvarchar(255),
AUTOPARTE_MODELO decimal(18,0),
FOREIGN KEY (AUTOPARTE_MODELO) REFERENCES NAPOLITANA_CON_FRITAS.BI_Modelo(MODELO_CODIGO)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Potencia_Rango (
ID int PRIMARY KEY,
RANGO varchar(10)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Mes (
ID int IDENTITY PRIMARY KEY,
ANIO int,
MES int
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Cliente(
ID int PRIMARY KEY,
RANGO_EDAD varchar(15),
SEXO varchar(10)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Cantidad_Rango(
ID int PRIMARY KEY,
RANGO varchar(20)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Cantidad_Cambios(
ID int PRIMARY KEY,
CANTIDAD varchar(4)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Tipo_Motor(
ID int IDENTITY PRIMARY KEY,
CODIGO_MOTOR decimal(18,0)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Rubro_Autoparte(
ID INT IDENTITY PRIMARY KEY,
RUBRO varchar(20)
);

-- Creacion de las tablas de hechos
CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Venta_Auto(
MES_ID int,
SUCURSAL_ID decimal(18,0),
CLIENTE_ID int,
MODELO_ID decimal(18,0),
FABRICANTE_ID decimal(18,0),
TIPO_AUTO_ID decimal(18,0),
TIPO_CAJA_ID decimal(18,0),
TIPO_MOTOR_ID decimal(18,0), 
TIPO_TRANSMISION_ID decimal(18,0),
POTENCIA_RANGO_ID int,
PRECIO decimal(18,2) DEFAULT 0,
CANTIDAD decimal(18,0) DEFAULT 0,
PRIMARY KEY (MES_ID,SUCURSAL_ID,CLIENTE_ID,MODELO_ID,FABRICANTE_ID,TIPO_AUTO_ID,TIPO_CAJA_ID,TIPO_MOTOR_ID,TIPO_TRANSMISION_ID,POTENCIA_RANGO_ID),
FOREIGN KEY (MES_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Mes(ID),
FOREIGN KEY (SUCURSAL_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Sucursal(SUCURSAL_ID),
FOREIGN KEY (CLIENTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Cliente(ID),
FOREIGN KEY (MODELO_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Modelo(MODELO_CODIGO),
FOREIGN KEY (FABRICANTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Fabricante(FABRICANTE_ID),
FOREIGN KEY (TIPO_AUTO_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Auto(TIPO_AUTO_CODIGO),
FOREIGN KEY (TIPO_CAJA_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Caja(TIPO_CAJA_CODIGO),
FOREIGN KEY (TIPO_TRANSMISION_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Transmision(TIPO_TRANSMISION_CODIGO),
FOREIGN KEY (POTENCIA_RANGO_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Potencia_Rango(ID)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Compra_Auto(
MES_ID int,
SUCURSAL_ID decimal(18,0),
CLIENTE_ID int,
MODELO_ID decimal(18,0),
FABRICANTE_ID decimal(18,0),
TIPO_AUTO_ID decimal(18,0),
TIPO_CAJA_ID decimal(18,0),
TIPO_MOTOR_ID int,
CANTIDAD_CAMBIOS_ID int,
TIPO_TRANSMISION_ID decimal(18,0),
POTENCIA_RANGO_ID int,
PRECIO decimal(18,2) DEFAULT 0,
CANTIDAD decimal(18,0) DEFAULT 0,
PRIMARY KEY (MES_ID,SUCURSAL_ID,CLIENTE_ID,MODELO_ID,FABRICANTE_ID,TIPO_AUTO_ID,TIPO_CAJA_ID,TIPO_MOTOR_ID,TIPO_TRANSMISION_ID,POTENCIA_RANGO_ID),
FOREIGN KEY (MES_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Mes(ID),
FOREIGN KEY (SUCURSAL_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Sucursal(SUCURSAL_ID),
FOREIGN KEY (CLIENTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Cliente(ID),
FOREIGN KEY (MODELO_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Modelo(MODELO_CODIGO),
FOREIGN KEY (FABRICANTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Fabricante(FABRICANTE_ID),
FOREIGN KEY (TIPO_AUTO_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Auto(TIPO_AUTO_CODIGO),
FOREIGN KEY (TIPO_CAJA_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Caja(TIPO_CAJA_CODIGO),
FOREIGN KEY (TIPO_TRANSMISION_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Transmision(TIPO_TRANSMISION_CODIGO),
FOREIGN KEY (POTENCIA_RANGO_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Potencia_Rango(ID),
FOREIGN KEY (TIPO_MOTOR_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Tipo_Motor(ID),
FOREIGN KEY (CANTIDAD_CAMBIOS_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Cantidad_Cambios(ID)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Venta_Autoparte(
AUTOPARTE_ID decimal(18,0),
MES_ID int,
SUCURSAL_ID decimal(18,0),
CLIENTE_ID int,
FABRICANTE_ID decimal(18,0),
CANTIDAD_RANGO_ID int,
RUBRO_AUTOPARTE_ID int,
PRECIO decimal(18,2) DEFAULT 0,
CANTIDAD decimal(18,0) DEFAULT 0,
PRIMARY KEY (AUTOPARTE_ID,MES_ID,SUCURSAL_ID,CLIENTE_ID,FABRICANTE_ID,CANTIDAD_RANGO_ID,RUBRO_AUTOPARTE_ID),
FOREIGN KEY (AUTOPARTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Autoparte(AUTOPARTE_CODIGO),
FOREIGN KEY (MES_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Mes(ID),
FOREIGN KEY (SUCURSAL_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Sucursal(SUCURSAL_ID),
FOREIGN KEY (CLIENTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Cliente(ID),
FOREIGN KEY (FABRICANTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Fabricante(FABRICANTE_ID),
FOREIGN KEY (CANTIDAD_RANGO_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Cantidad_Rango(ID),
FOREIGN KEY (RUBRO_AUTOPARTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Rubro_Autoparte(ID)
);

CREATE TABLE NAPOLITANA_CON_FRITAS.BI_Compra_Autoparte(
AUTOPARTE_ID decimal(18,0),
MES_ID int,
SUCURSAL_ID decimal(18,0),
CLIENTE_ID int,
FABRICANTE_ID decimal(18,0),
CANTIDAD_RANGO_ID int,
RUBRO_AUTOPARTE_ID int,
PRECIO decimal(18,2) DEFAULT 0,
CANTIDAD decimal(18,0) DEFAULT 0,
PRIMARY KEY (AUTOPARTE_ID,MES_ID,SUCURSAL_ID,CLIENTE_ID,FABRICANTE_ID,CANTIDAD_RANGO_ID,RUBRO_AUTOPARTE_ID),
FOREIGN KEY (AUTOPARTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Autoparte(AUTOPARTE_CODIGO),
FOREIGN KEY (MES_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Mes(ID),
FOREIGN KEY (SUCURSAL_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Sucursal(SUCURSAL_ID),
FOREIGN KEY (CLIENTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Cliente(ID),
FOREIGN KEY (FABRICANTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Fabricante(FABRICANTE_ID),
FOREIGN KEY (CANTIDAD_RANGO_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Cantidad_Rango(ID),
FOREIGN KEY (RUBRO_AUTOPARTE_ID) REFERENCES NAPOLITANA_CON_FRITAS.BI_Rubro_Autoparte(ID)
);

-- Se populan las tablas parametricas del modelo BI
INSERT INTO NAPOLITANA_CON_FRITAS.BI_Potencia_Rango (ID, RANGO) 
VALUES (1,'50-150cv'), (2,'151-300cv'), (3,'>300cv');

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Cliente (ID, RANGO_EDAD, SEXO) 
VALUES (1,'18 - 30 años', 'MASCULINO'), (2,'31 - 50 años', 'MASCULINO'), (3,'> 50 años', 'MASCULINO'), 
	   (4,'18 - 30 años', 'FEMENINO'), (5,'31 - 50 años', 'FEMENINO'), (6,'> 50 años', 'FEMENINO'),
	   (7,'18 - 30 años', 'NO INFORMA'), (8,'31 - 50 años', 'NO INFORMA'), (9,'> 50 años', 'NO INFORMA');

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Cantidad_Rango(ID, RANGO) 
VALUES (1,'1 - 10 items'), (2,'11 - 50 items'), (3,'51 - 100 items'), (4,'> 100 items');

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Cantidad_Cambios
VALUES (1,'5'), (2,'6'), (3,'S/D');

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Tipo_Motor
SELECT DISTINCT MODELO_TIPO_MOTOR FROM NAPOLITANA_CON_FRITAS.Modelo

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Fabricante
SELECT * FROM NAPOLITANA_CON_FRITAS.Fabricante

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Tipo_Auto
SELECT * FROM NAPOLITANA_CON_FRITAS.Tipo_Auto

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Tipo_Caja
SELECT * FROM NAPOLITANA_CON_FRITAS.Tipo_Caja

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Tipo_Transmision
SELECT * FROM NAPOLITANA_CON_FRITAS.Tipo_Transmision

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Modelo
SELECT * FROM NAPOLITANA_CON_FRITAS.Modelo

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Sucursal
SELECT * FROM NAPOLITANA_CON_FRITAS.Sucursal

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Autoparte
SELECT * FROM NAPOLITANA_CON_FRITAS.Autoparte

INSERT INTO NAPOLITANA_CON_FRITAS.BI_Mes
SELECT DISTINCT YEAR(COMPRA_FECHA), MONTH(COMPRA_FECHA) FROM NAPOLITANA_CON_FRITAS.Compra
UNION
SELECT DISTINCT YEAR(FACTURA_FECHA), MONTH(FACTURA_FECHA) FROM NAPOLITANA_CON_FRITAS.Factura

